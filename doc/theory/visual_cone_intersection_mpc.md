# UAVの視野錐台交差制約付きMPC問題の定式化：CBFとCCBFの比較

## 1. 問題設定

### 1.1 UAVのダイナミクス

$N$台のUAV（無人航空機）からなるシステムを考える。各UAV $i \in \{1, 2, \ldots, N\}$ の状態を $x_i \in \mathbb{R}^{n_x}$ とし、制御入力を $u_i \in \mathbb{R}^{n_u}$ とする。UAVのダイナミクスは以下の制御アフィンシステムで表される：

$$\dot{x}_i = f_i(x_i) + g_i(x_i)u_i$$

ここで、$f_i: \mathbb{R}^{n_x} \rightarrow \mathbb{R}^{n_x}$ と $g_i: \mathbb{R}^{n_x} \rightarrow \mathbb{R}^{n_x \times n_u}$ は滑らかな関数である。

UAVの状態 $x_i$ には、位置 $p_i \in \mathbb{R}^3$、姿勢（クォータニオンまたはオイラー角）$q_i$、線形速度 $v_i \in \mathbb{R}^3$、角速度 $\omega_i \in \mathbb{R}^3$ などが含まれる。簡単のため、以下では位置と姿勢のみを考慮する。

### 1.2 視野錐台モデル

各UAV $i$ はカメラを搭載しており、その視野は錐台（視野錐台）として表現できる。視野錐台は以下のパラメータで特徴づけられる：

- 視野の中心方向（カメラの光軸方向）: $d_i \in \mathbb{R}^3$（単位ベクトル）
- 水平視野角: $\theta_h$
- 垂直視野角: $\theta_v$
- 最小視認距離: $r_{min}$
- 最大視認距離: $r_{max}$

UAV $i$ の位置 $p_i$ と姿勢 $q_i$ から、視野の中心方向 $d_i$ は以下のように計算できる：

$$d_i = R(q_i) \cdot [0, 0, 1]^T$$

ここで、$R(q_i)$ は姿勢 $q_i$ に対応する回転行列である。

### 1.3 視野錐台交差制約

本研究の主要な制約は、複数のUAVの視野錐台が交差することである。特に、環境内の特徴点（ランドマーク）が複数のUAVによって同時に観測されることを保証したい。

特徴点 $l \in \mathbb{R}^3$ がUAV $i$ の視野内にあるかどうかは、以下の条件で判定できる：

1. 距離条件: $r_{min} \leq \|p_i - l\| \leq r_{max}$
2. 角度条件: $\cos^{-1}\left(\frac{(l - p_i)^T d_i}{\|l - p_i\|}\right) \leq \min(\theta_h/2, \theta_v/2)$

簡単のため、視野角が円錐状（$\theta_h = \theta_v = \theta$）であると仮定すると、角度条件は以下のように簡略化できる：

$$\frac{(l - p_i)^T d_i}{\|l - p_i\|} \geq \cos(\theta/2)$$

特徴点 $l$ が少なくとも $M$ 台のUAV（$M \leq N$）によって同時に観測されるという制約は、以下のように表現できる：

$$\sum_{i=1}^{N} \mathbf{1}_{\{l \text{ is in the FOV of UAV } i\}} \geq M$$

ここで、$\mathbf{1}_{\{\cdot\}}$ は指示関数である。

### 1.4 制御目標

各UAV $i$ は、以下の目標を達成するように制御する：

1. 目標軌道 $x_{i,ref}(t)$ への追従
2. 視野錐台交差制約の満足
3. UAV間の衝突回避
4. 制御入力の最小化

これらの目標を達成するために、Model Predictive Control (MPC) フレームワークを採用する。

## 2. 通常のCBFを用いた定式化

### 2.1 視野錐台交差のためのCBF

通常のCBF（Control Barrier Function）アプローチでは、各UAVが独立して自身の制約を満たすように制御入力を決定する。視野錐台交差制約をCBFとして表現するために、以下のバリア関数を定義する：

$$h_{ij}(x_i, x_j) = \cos(\alpha_{ij}) - \cos(\gamma)$$

ここで、$\alpha_{ij}$ はUAV $i$ とUAV $j$ の視野の中心方向のなす角、$\gamma$ は許容される最大角度である。$\cos(\alpha_{ij})$ は以下のように計算できる：

$$\cos(\alpha_{ij}) = d_i^T d_j$$

このバリア関数は、UAV $i$ とUAV $j$ の視野の中心方向が十分に近い（角度が $\gamma$ 以下）ときに正の値をとる。

さらに、UAV間の距離に関するバリア関数も定義する：

$$h_{ij}^{dist}(x_i, x_j) = d_{max}^2 - \|p_i - p_j\|^2$$

ここで、$d_{max}$ は許容される最大距離である。

これらのバリア関数を組み合わせることで、視野錐台交差の条件を表現できる：

$$h_{ij}^{combined}(x_i, x_j) = \min(h_{ij}(x_i, x_j), h_{ij}^{dist}(x_i, x_j))$$

または、滑らかな近似として：

$$h_{ij}^{combined}(x_i, x_j) = -\log(\exp(-h_{ij}(x_i, x_j)) + \exp(-h_{ij}^{dist}(x_i, x_j)))$$

### 2.2 衝突回避のためのCBF

UAV間の衝突回避のために、以下のバリア関数を定義する：

$$h_{ij}^{collision}(x_i, x_j) = \|p_i - p_j\|^2 - d_{safe}^2$$

ここで、$d_{safe}$ は安全距離である。

### 2.3 CBF制約付きMPC

各UAV $i$ に対して、以下のMPC問題を解く：

$$
\begin{aligned}
\min_{u_i(t)} \quad & \int_{t}^{t+T} \|x_i(\tau) - x_{i,ref}(\tau)\|_Q^2 + \|u_i(\tau)\|_R^2 d\tau \\
\text{s.t.} \quad & \dot{x}_i(\tau) = f_i(x_i(\tau)) + g_i(x_i(\tau))u_i(\tau), \quad \tau \in [t, t+T] \\
& x_i(t) = x_{i,current} \\
& u_i(\tau) \in \mathcal{U}_i, \quad \tau \in [t, t+T] \\
& \dot{h}_{ij}^{combined}(x_i(\tau), x_j(\tau)) + \alpha(h_{ij}^{combined}(x_i(\tau), x_j(\tau))) \geq 0, \quad \forall j \neq i, \tau \in [t, t+T] \\
& \dot{h}_{ij}^{collision}(x_i(\tau), x_j(\tau)) + \alpha(h_{ij}^{collision}(x_i(\tau), x_j(\tau))) \geq 0, \quad \forall j \neq i, \tau \in [t, t+T]
\end{aligned}
$$

ここで、$T$ は予測ホライズン、$Q$ と $R$ は重み行列、$\mathcal{U}_i$ は制御入力の制約集合、$\alpha$ はクラス $\mathcal{K}$ 関数である。

この最適化問題は、各UAVが独立して解く。ただし、他のUAVの状態 $x_j$ は既知であると仮定する。実際には、通信によって他のUAVの状態を取得するか、予測モデルを用いて推定する必要がある。

### 2.4 実装上の課題

通常のCBFアプローチには、以下の課題がある：

1. **局所的な視点**: 各UAVは自身と他のUAVとのペアワイズな関係のみを考慮し、システム全体の状態を考慮していない。
2. **通信要件**: 各UAVは他のすべてのUAVの状態を知る必要があり、完全な通信が必要。
3. **スケーラビリティ**: UAVの数が増えると、各UAVが考慮すべき制約の数が二次的に増加する。
4. **保守性**: 各UAVが独立して制約を満たそうとするため、過度に保守的な制御になる可能性がある。

## 3. CCBFを用いた定式化

### 3.1 視野錐台交差のためのCCBF

Consensus-Based Control Barrier Function (CCBF) アプローチでは、システム全体の状態に対する単一のバリア関数を定義し、それを各UAVが協調して満たすようにする。

視野錐台交差制約に対するグローバルなバリア関数として、以下を定義する：

$$B(x_1, x_2, \ldots, x_N) = \sum_{i=1}^{N-1} \sum_{j=i+1}^{N} \phi(h_{ij}^{combined}(x_i, x_j))$$

ここで、$\phi$ は単調増加関数である。例えば、$\phi(z) = \max(0, z)$ または滑らかな近似として $\phi(z) = \log(1 + \exp(z))$ などが考えられる。

このバリア関数は、すべてのUAVペア間の視野錐台交差の度合いを総和として表現している。

### 3.2 CCBFの分散実装

CCBFの分散実装のために、各UAV $i$ は補助変数 $y_i$ を持ち、コンセンサスフィルタを用いてグローバルなバリア関数の値を近似する：

$$\dot{y}_i = k_L \sum_{j \in \mathcal{N}_i} (y_j - y_i) + \dot{\psi}_i(x_i)$$
$$y_i(0) = \psi_i(x_i(0))$$

ここで、$k_L > 0$ はコンセンサスのゲイン、$\mathcal{N}_i$ はUAV $i$ の通信可能な近傍集合、$\psi_i(x_i)$ はUAV $i$ の状態に依存する項である。

視野錐台交差制約の場合、$\psi_i(x_i)$ は以下のように定義できる：

$$\psi_i(x_i) = \sum_{j \neq i} \phi(h_{ij}^{combined}(x_i, x_j))$$

コンセンサスフィルタにより、各UAV $i$ の補助変数 $y_i$ は、グローバルなバリア関数 $B$ の値に収束する。

### 3.3 CCBF制約付きMPC

各UAV $i$ に対して、以下のMPC問題を解く：

$$
\begin{aligned}
\min_{u_i(t)} \quad & \int_{t}^{t+T} \|x_i(\tau) - x_{i,ref}(\tau)\|_Q^2 + \|u_i(\tau)\|_R^2 d\tau \\
\text{s.t.} \quad & \dot{x}_i(\tau) = f_i(x_i(\tau)) + g_i(x_i(\tau))u_i(\tau), \quad \tau \in [t, t+T] \\
& x_i(t) = x_{i,current} \\
& u_i(\tau) \in \mathcal{U}_i, \quad \tau \in [t, t+T] \\
& \sum_{m \in \mathcal{M}} \nabla \phi_m(ny_{im})^T \dot{\psi}_{im}(x_i) \geq \alpha \sum_{m \in \mathcal{M}} \phi_m(ny_{im}), \quad \tau \in [t, t+T] \\
& \dot{h}_{ij}^{collision}(x_i(\tau), x_j(\tau)) + \alpha(h_{ij}^{collision}(x_i(\tau), x_j(\tau))) \geq 0, \quad \forall j \neq i, \tau \in [t, t+T]
\end{aligned}
$$

ここで、$\mathcal{M}$ はバリア関数の集合、$n$ はUAVの数、$y_{im}$ はUAV $i$ の補助変数、$\psi_{im}$ はUAV $i$ の状態に依存する項である。

この最適化問題では、各UAVは自身の制御入力のみを最適化するが、コンセンサスフィルタを通じてグローバルなバリア関数の値を考慮している。

### 3.4 実装上の利点と課題

CCBFアプローチには、以下の利点がある：

1. **グローバルな視点**: システム全体の状態を考慮したバリア関数を用いることで、より効率的な制御が可能。
2. **局所通信**: 各UAVは近傍のUAVとのみ通信すればよく、完全な通信は不要。
3. **スケーラビリティ**: UAVの数が増えても、各UAVが考慮すべき通信相手は近傍のみであり、スケーラブル。
4. **協調性**: 各UAVが協調してグローバルな制約を満たすため、より効率的な解が得られる可能性がある。

一方、以下の課題もある：

1. **通信遅延**: コンセンサスフィルタの収束には時間がかかり、通信遅延が大きいと性能が低下する可能性がある。
2. **実装の複雑さ**: 補助変数の導入やコンセンサスフィルタの実装など、通常のCBFよりも複雑になる。
3. **収束性の保証**: コンセンサスフィルタが十分速く収束することを保証する必要がある。

## 4. 両アプローチの比較と考察

### 4.1 理論的比較

#### 4.1.1 安全性保証

通常のCBFアプローチでは、各UAVが独立して安全制約を満たすことを保証する。一方、CCBFアプローチでは、システム全体として安全制約を満たすことを保証する。

理論的には、両アプローチとも安全性（バリア関数の非負性）を保証するが、CCBFの方がより厳密にグローバルな制約を扱える。

#### 4.1.2 最適性

通常のCBFアプローチでは、各UAVが独立して最適化問題を解くため、システム全体としては局所最適解しか得られない可能性がある。一方、CCBFアプローチでは、各UAVが協調してグローバルな制約を満たすため、より良い解が得られる可能性がある。

ただし、CCBFの場合も完全な大域的最適解を保証するものではなく、コンセンサスフィルタの収束速度や通信トポロジーに依存する。

#### 4.1.3 計算複雑性

通常のCBFアプローチでは、各UAVが $O(N)$ の制約を持つ最適化問題を解く必要がある。一方、CCBFアプローチでは、各UAVが $O(|\mathcal{N}_i|)$ の制約を持つ最適化問題を解き、さらにコンセンサスフィルタの計算が必要になる。

UAVの数が多く、通信トポロジーがスパースな場合（$|\mathcal{N}_i| \ll N$）、CCBFアプローチの方が計算効率が良い可能性がある。

### 4.2 視野錐台交差制約への適用

視野錐台交差制約は、本質的にUAV間の協調を必要とする制約である。特に、「少なくとも $M$ 台のUAVが同じ特徴点を観測する」という制約は、システム全体の状態に依存するグローバルな制約である。

通常のCBFアプローチでは、この制約をペアワイズな制約の集合として近似的に表現するしかない。例えば、「すべてのUAVペアの視野が交差する」という制約を課すことで、間接的に視野錐台交差を促進することはできるが、厳密に「$M$ 台のUAVが同じ特徴点を観測する」ことを保証するのは難しい。

一方、CCBFアプローチでは、システム全体の状態に依存するバリア関数を直接定義できるため、「$M$ 台のUAVが同じ特徴点を観測する」という制約をより自然に表現できる。例えば、以下のようなバリア関数が考えられる：

$$B(x_1, x_2, \ldots, x_N) = \sum_{l \in \mathcal{L}} \phi\left(\sum_{i=1}^{N} \mathbf{1}_{\{l \text{ is in the FOV of UAV } i\}} - M\right)$$

ここで、$\mathcal{L}$ は観測すべき特徴点の集合、$\phi$ は単調増加関数である。

このバリア関数は、各特徴点が少なくとも $M$ 台のUAVによって観測されることを促進する。CCBFアプローチを用いることで、このようなグローバルな制約を分散的に満たすことが可能になる。

### 4.3 実装上の考慮事項

実際のシステムに実装する際には、以下の点を考慮する必要がある：

1. **通信インフラ**: CCBFアプローチでは、UAV間の通信が不可欠である。通信の信頼性、帯域幅、遅延などを考慮した設計が必要。
2. **計算リソース**: MPC問題を実時間で解くための計算リソースが必要。特に、予測ホライズンが長い場合や制約が多い場合は計算負荷が高くなる。
3. **ロバスト性**: センサーノイズ、通信遅延、モデル誤差などに対するロバスト性を確保する必要がある。
4. **フォールバック戦略**: 通信が途絶した場合や計算が間に合わない場合のフォールバック戦略を用意しておく。

## 5. 結論

本研究では、UAVの視野錐台交差制約付きMPC問題に対して、通常のCBFとCCBFの2つのアプローチを比較検討した。

通常のCBFアプローチは実装が比較的簡単であり、各UAVが独立して安全制約を満たすことを保証できる。一方、CCBFアプローチはより複雑だが、システム全体の状態を考慮したグローバルな制約を扱うことができ、特に視野錐台交差のような協調を要する制約に適している。

視野錐台交差制約を持つマルチUAV協調SLAMシステムにおいては、CCBFアプローチの方が理論的には優れていると考えられる。ただし、実装の複雑さや通信要件などの実用的な課題も考慮する必要がある。

今後の研究では、両アプローチの実装と評価を行い、実際のシステムにおける性能を比較することが重要である。また、通信遅延やセンサーノイズなどの実世界の制約を考慮したロバストな制御手法の開発も課題である。
