# CCBF Theory Summary for Collaborative Visual-Inertial SLAM

このドキュメントは、複数UAVによる協調的visual-inertial SLAMシステムにおける**Consensus-Based Control Barrier Function (CCBF)** に基づく理論的枠組みおよび、それに組み込む視野錐台交差制約・特徴点共有、不確かさ低減を含むMPC問題の定式化について、既存研究との比較やサーベイ結果に基づく検討結果をまとめたものです。

---

## 1. はじめに

従来の手法では、各UAVが独立して自己位置推定と安全制御を行うため、視野（FoV）の交差や特徴点共有は、局所的な条件に限定されることが多かった。しかし、協調自己位置推定を実現するためには、エージェント間で十分な特徴点共有や、オクルージョンを含む視認性条件をグローバルに管理する必要があります。

本研究では、CCBFアプローチを用い、以下の課題に取り組みました：

1. **十分な特徴点共有の定量化**  
   UAV間で全ての特徴点を共有するのは現実的ではなく、協調自己位置推定に必要な「十分な」共有特徴点の定義と評価指標（共有点数、空間的分散、観測品質）を導入しました。

2. **オクルージョンを考慮した視野錐台交差制約**  
   距離と角度のみの評価では、実際の環境に存在する遮蔽物（オクルージョン）を十分に捉えられません。本手法では、オクルージョン検出（例えば、オクテomapによるレイトレーシング）と、符号付距離関数（SDF）や凸近似を用い、オクルージョン状況下での視認性維持を実現するよう定式化しました。

3. **自己位置推定不確かさを最小化する目的関数**  
   アクティブSLAMの文脈で、ロボットの将来の不確かさ（エントロピー、共分散行列の行列式）を目的関数に組み込み、MPC問題として目標追従と不確かさ低減のトレードオフを最適化する手法を提案しました。これにより、協調的な情報利得を明示的に活用します。

---

## 2. 理論モデルと定式化

### 2.1 特徴点共有の定量化

- **視野判定関数 $v_i(l)$**  
  各UAV $i$ について、特徴点 $l \in \mathbb{R}^3$ が視野内にあるかを次式で定義します。
  $$
  v_i(l) = 
  \begin{cases}
  1 & \text{if } l \text{ is in the FOV of UAV } i, \\
  0 & \text{otherwise.}
  \end{cases}
  $$
  
- **共有特徴点集合および評価**:  
  UAV $i$ と UAV $j$ の共有可能な特徴点集合 $\mathcal{L}_{ij}$ を  
  $$
  \mathcal{L}_{ij} = \{ l \in \mathcal{L} \mid v_i(l)=1 \text{ and } v_j(l)=1 \}
  $$
  と定義し、共有点数 $n_{ij}$、空間的分散（共分散行列 $\Sigma_{ij}$）、および平均観測品質 $Q_{ij}$ を計算します。

- **バリア関数 $h_{ij}^{feature}$**:  
  これらの指標を組み合わせ、以下のハード制約として定式化します。
  $$
  h_{ij}^{feature}(x_i, x_j) = w_1 (n_{ij} - n_{min}) + w_2 (\det(\Sigma_{ij}) - \sigma_{min}) + w_3 (Q_{ij} - q_{min})
  $$
  ここで、$n_{min}, \sigma_{min}, q_{min}$ は閾値です。

### 2.2 オクルージョンを考慮した視認性評価

- **オクルージョンモデル**:  
  環境中の障害物集合 $\mathcal{O} = \{O_1, O_2, \ldots, O_M\}$ を考え、各障害物 $O_m$ は凸多面体で表現します。  
  UAV $i$ から特徴点 $l$ 前に障害物に遮られるかを次式で判定します。
  $$
  o_i(l, O_m) =
  \begin{cases}
    1 & \text{if the line segment from } p_i \text{ to } l \text{ intersects } O_m, \\
    0 & \text{otherwise.}
  \end{cases}
  $$
  その上で、
  $$
  o_i(l) = \max_{m=1,\ldots,M} o_i(l, O_m)
  $$
  
- **再定義された視認性関数 $v_i(l)$**:  
  オクルージョンがない場合のみ視認性が有効となるよう、条件を拡張します。
  $$
  v_i(l) = 
  \begin{cases}
  1 & \text{if } r_{min} \leq \|p_i-l\| \leq r_{max} \text{, } \frac{(l-p_i)^T d_i}{\|l-p_i\|} \geq \cos(\theta/2) \text{, and } o_i(l)=0, \\
  0 & \text{otherwise.}
  \end{cases}
  $$
  
- **オクルージョン回避バリア関数 $h_{ij}^{occlusion}$**:  
  両エージェントが対象をオクルージョンなしに見る状況を評価するため、次のように定義します。
  $$
  h_{ij}^{occlusion}(x_i, x_j) = \sum_{l \in \mathcal{L}} w_l (1 - o_i(l))(1 - o_j(l))v_i(l)v_j(l)
  $$

- **オクルージョン平面を用いた補助評価**:  
  障害物の平面集合 $\mathcal{P}_m$ を利用し、平面からの距離に基づく評価指標 $h_{ij}^{plane}$ も定義します。
  $$
  h_{ij}^{plane}(x_i, x_j) = \min_{l \in \mathcal{L},\, m,k} \Bigl( d_{i,l,m,k} - d_{safe} \Bigr)
  $$
  ここで $d_{i,l,m,k}$ は、UAV $i$ から特徴点 $l$ までの視線と平面 $P_{mk}$ との距離です。

### 2.3 自己位置推定不確かさの最小化

- **不確かさモデル**:  
  視覚慣性SLAMでは、各UAVの自己位置不確かさはフィッシャー情報量（FIM）に基づく共分散行列$\Sigma_i$で表されます。
  $$
  \Sigma_i = \Biggl( \sum_{l\in\mathcal{L}} v_i(l)q_i(l)J_lJ_l^T \Biggr)^{-1}
  $$
  複数UAVが協調した場合は、共有情報を使い追加的な利得が得られます：
  $$
  \Sigma_{ij} = \Bigl( \Sigma_i^{-1} + \Sigma_j^{-1} - \Sigma_{ij,common}^{-1} \Bigr)^{-1}
  $$
  
- **目的関数**:  
  UAV全体の不確かさ低減を目的として、以下の目的関数を定義します。
  $$
  J_{uncertainty}(x_1,x_2,\ldots,x_N)=\sum_{i=1}^N \text{tr}(\Sigma_i) - \sum_{i=1}^{N-1}\sum_{j=i+1}^N \text{tr}(\Sigma_{ij})
  $$
  これにより、協調による情報利得を直接評価可能とします。

---

## 3. 分散MPC問題の定式化と解法のアルゴリズムシーケンス

### 3.1 分散MPC問題の定式化

各UAVは、以下のような局所MPC問題を解いて制御入力 $u_i(t)$ を計算します：
$$
\begin{aligned}
\min_{u_i(\cdot)}\quad & \int_{t}^{t+T} \Bigl( w_1\,\text{tr}(\Sigma_i(\tau)) + w_2\,\|x_i(\tau)-x_{i,ref}(\tau)\|^2_Q + w_3\,\|u_i(\tau)\|^2_R \Bigr)d\tau, \\
\text{s.t.}\quad & \dot{x}_i(\tau)=f_i(x_i(\tau))+g_i(x_i(\tau)) u_i(\tau),\quad \tau\in[t,t+T], \\
& x_i(t)=x_{i,current},\quad u_i(\tau)\in\mathcal{U}_i, \quad \tau\in[t,t+T], \\
& \text{CCBFおよび他の安全制約（例：}\sum_{m\in\mathcal{M}} \nabla\phi_m(ny_{im})^T \dot{\psi}_{im}(x_i) \geq \alpha\sum_{m\in\mathcal{M}}\phi_m(ny_{im})\text{等）}
\end{aligned}
$$

ここで、補助変数 $\psi_i(x_i)$ は、各UAVの局所評価（特徴点共有、オクルージョン評価）に基づいて計算され、エージェント間でコンセンサスフィルタとして補助変数 $y_i$ が用いられます。

### 3.2 アルゴリズムシーケンス

**(1) ローカル計算**  
各エージェントは、自身のセンサデータから以下を計算する：
- 状態 $x_i$、姿勢 $d_i$ 等の自己状態
- 特徴点集合 $\mathcal{L}$ の抽出と、局所視野判定 $v_i(l)$ および観測品質 $q_i(l)$ の計算
- $\mathcal{L}_{ij}$ を通じた共有特徴評価：$n_{ij}$、$\Sigma_{ij}$、$Q_{ij}$ を算出し、バリア関数 $h_{ij}^{feature}$ を評価

**(2) オクルージョン評価**  
各エージェントは、環境マップやレイトレーシングを用いて、  
- オクルージョン状態 $o_i(l)$ を評価し  
- 補助的な視認性関数 $v_i(l)$ を更新  
- オクルージョン回避バリア関数 $h_{ij}^{occlusion}$ および、必要なら $h_{ij}^{plane}$ を評価

**(3) 補助変数の計算と通信**  
ローカル評価に基づき、  
- 補助変数 $\psi_i(x_i)$ を算出：  
  $$
  \psi_i(x_i)=\sum_{j\neq i}\phi\Bigl( w_1\, h_{ij}^{feature} + w_2\, h_{ij}^{occlusion} + w_3\, h_{ij}^{plane} \Bigr)
  $$
- 初期値 $y_i(0)=\psi_i(x_i(0))$ として、  
- 制御周期ごとに、近傍（$\mathcal{N}_i$）と補助変数 $y_i$ を交換し、コンセンサスフィルタにより次の更新式を適用：  
  $$
  \dot{y}_i = k_L\sum_{j\in\mathcal{N}_i}(y_j-y_i) + \dot{\psi}_i(x_i)
  $$

**(4) 局所MPC問題の解法**  
各エージェントは、上記更新された局所状態、補助変数 $y_i$、および不確かさモデル $\Sigma_i$ を利用して、局所MPC問題を解く。最適化ソルバー（内点法、逐次線形化法など）により、次の制御入力 $u_i(t)$ が求められ、その入力が実行されます。

**(5) 反復更新**  
各制御サイクルで以下を繰り返す：  
- センサデータ取得と局所評価の更新  
- 補助変数 $\psi_i$ の再計算と通信によるコンセンサス更新  
- 最新の局所状態と補助変数に基づいて再最適化し、次の入力を計算  
- 制御入力を実行し、状態更新を反映

---

## 4. 結論

この分散MPC問題の解法シーケンスは、各エージェントが自身のセンサ情報と近傍との通信を通じて、グローバルなCCBF制約条件をリアルタイムに反映しながら最適制御入力を計算するためのものです。特に、局所評価、補助変数のコンセンサス更新、局所MPC最適化のサイクルは、協調自己位置推定の精度向上と安全性保持の両方を実現するために不可欠です。

この理論研究は、CCBFを用いた協調制御システムの設計における通信タイミングやデータ共有、オンライン最適化のプロセスについての理解を深める一助となります。

---

以上が、エージェント間でどの変数をどのタイミングで通信する必要があるかなど、途中式や背後にあるアルゴリズムシーケンスについての理論的な説明となります。
