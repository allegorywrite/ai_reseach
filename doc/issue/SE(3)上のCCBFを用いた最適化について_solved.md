# SE(3)上のCCBFを用いた最適化について（解決済み）

## 提起された課題

実際のドローンのダイナミクスについて最適化を行うためには，SE(3)上でのダイナミクス表現や最適化を用いる必要があります．現在定式化しているCCBF付きMPCをリー群及びSE(3)上で再定式化してください。
リー群のCBFへの適用については一度サーベイを要求したほうが良いかもしれません。

## 解決策

リー群およびSE(3)上でのConsensus-Based Control Barrier Function (CCBF)を用いた最適化問題の定式化と解法について、詳細な理論研究を行いました。サーベイ結果（Task 4）を踏まえ、SE(3)上でのCCBF制約付きMPC問題を再定式化しました。

### 主な成果

1. **リー群とSE(3)の基礎理論の整理**
   - リー群の定義と性質
   - SE(3)の定義と表現
   - SE(3)上のドローンダイナミクス

2. **リー群上のControl Barrier Function (CBF)の定式化**
   - リー群上のCBFの定義
   - SE(3)上のCBFの具体例（障害物回避、視野内保持など）
   - SE(3)上のCBFの微分計算

3. **SE(3)上のConsensus-Based Control Barrier Function (CCBF)の定式化**
   - CCBFの定義と性質
   - SE(3)上のCCBFの具体例（衝突回避、特徴点共有など）
   - SE(3)上のCCBFの微分計算

4. **SE(3)上のCCBF制約付きMPC問題の定式化**
   - 問題設定
   - コスト関数の設計
   - CCBF制約の離散化

5. **SE(3)上のCCBF制約付きMPC問題の解法**
   - リーマン多様体上の最適化
   - 逐次二次計画法（SQP）
   - 分散実装

### 詳細な定式化

SE(3)上のCCBF制約付きMPC問題は以下のように定式化されます：

$$\min_{u_i(0), \ldots, u_i(N-1)} \sum_{k=0}^{N-1} \ell_i(X_i(k), \xi_i(k), u_i(k)) + \ell_{i,f}(X_i(N), \xi_i(N))$$

制約条件：
$$X_i(k+1) = X_i(k) \exp(\Delta t \xi_i(k)^\wedge)$$
$$\xi_i(k+1) = f_i(X_i(k), \xi_i(k), u_i(k))$$
$$X_i(0) = X_{i,\text{current}}, \quad \xi_i(0) = \xi_{i,\text{current}}$$
$$u_{i,\text{min}} \leq u_i(k) \leq u_{i,\text{max}}, \quad k = 0, \ldots, N-1$$
$$h_i(X_i(k), X_j(k)) \geq 0, \quad j \in \mathcal{N}_i, \quad k = 0, \ldots, N$$

ここで：
- $X_i(k) \in SE(3)$ はエージェント $i$ の時刻 $k$ における位置と姿勢
- $\xi_i(k) \in \mathbb{R}^6$ はエージェント $i$ の時刻 $k$ における速度（角速度と線速度）
- $u_i(k) \in \mathbb{R}^4$ はエージェント $i$ の時刻 $k$ における制御入力（推力とトルク）
- $\ell_i$ はステージコスト関数
- $\ell_{i,f}$ は終端コスト関数
- $f_i$ はエージェント $i$ のダイナミクス関数
- $h_i$ はエージェント $i$ のCCBF
- $\mathcal{N}_i$ はエージェント $i$ の近傍エージェントの集合

コスト関数は以下のように設計されます：

$$\ell_i(X_i, \xi_i, u_i) = w_1 d_{SE(3)}(X_i, X_{i,\text{ref}})^2 + w_2 \|\xi_i - \xi_{i,\text{ref}}\|^2 + w_3 \|u_i\|^2 + w_4 \text{tr}(\Sigma_i)$$

ここで：
- $d_{SE(3)}(X_i, X_{i,\text{ref}})$ は $X_i$ と $X_{i,\text{ref}}$ の間のSE(3)上の距離
- $\|\xi_i - \xi_{i,\text{ref}}\|$ は速度の追従誤差
- $\|u_i\|$ は制御入力のノルム
- $\text{tr}(\Sigma_i)$ は自己位置推定の不確かさ（共分散行列のトレース）
- $w_1, w_2, w_3, w_4$ は重み係数

SE(3)上の距離 $d_{SE(3)}(X_1, X_2)$ は、以下のように定義されます：

$$d_{SE(3)}(X_1, X_2) = \|\log(X_1^{-1} X_2)\|$$

ここで、$\log$ はSE(3)からそのリー代数 $\mathfrak{se}(3)$ への対数写像、$\|\cdot\|$ はリー代数上のノルムです。

CCBF制約は以下のように離散化されます：

$$h_i(X_i(k+1), X_j(k+1)) - h_i(X_i(k), X_j(k)) \geq -\gamma h_i(X_i(k), X_j(k))$$

ここで、$\gamma \in (0, 1)$ はCBFパラメータです。

### 解法アプローチ

SE(3)上のCCBF制約付きMPC問題を解くために、以下のアプローチを提案します：

1. **リーマン多様体上の最適化**
   - 問題をリー代数 $\mathfrak{se}(3)$ 上の最適化問題に変換
   - リー代数上で最適化アルゴリズムを適用
   - 最適解をリー群 $SE(3)$ に戻す

2. **逐次二次計画法（SQP）**
   - 各反復で目的関数と制約を二次近似
   - QP問題を解いて探索方向を求める
   - レトラクション操作で解を更新

3. **分散実装**
   - 各エージェントが自身のMPC問題を解く
   - 近傍エージェントと情報を交換
   - コンセンサスフィルタを用いて補助変数を更新

### 実装上の考慮事項

1. **計算効率**
   - リー代数上での効率的な計算
   - 勾配と二次微分の解析的な計算
   - 並列計算の活用

2. **数値安定性**
   - 特異点の回避
   - 適切な正規化
   - 数値誤差の管理

3. **リアルタイム実装**
   - 計算時間の制約
   - 早期終了条件
   - ウォームスタート

## 成果物

詳細な理論研究の結果は、以下のドキュメントにまとめました：

- `doc/theory/se3_ccbf_optimization.md`: SE(3)上のCCBFを用いた最適化問題の定式化と解法に関する詳細な理論研究

このドキュメントでは、リー群とSE(3)の基礎から始まり、リー群上のCBFとCCBFの定義、SE(3)上のCCBF制約付きMPC問題の定式化と解法、数値例まで、包括的に説明しています。

## 今後の展望

1. **シミュレーション検証**
   - SE(3)上のCCBF制約付きMPC問題のシミュレーション実装
   - 従来のユークリッド空間での定式化との比較
   - パラメータ感度分析

2. **実機実装に向けた拡張**
   - 計算効率の向上
   - ロバスト性の強化
   - 階層的制御アーキテクチャへの統合

3. **理論的拡張**
   - 不確かさを考慮したロバストCCBF
   - 学習ベースのCCBF
   - 時変制約への対応

SE(3)上のCCBF制約付きMPC問題の定式化と解法に関する理論研究により、ドローンの協調的visual-inertial SLAMシステムにおける視野錐台交差制約付きMPC問題をより正確かつ効率的に解くことが可能になります。
