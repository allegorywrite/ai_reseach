# ドローンを対象としたLQRやMPCの実装について（解決済み）

## 提起された課題

実機への実装を見据えると、
$$u_i = [F_i, M_{i,x}, M_{i,y}, M_{i,z}]^T$$
のように推力を直接入力する方法はドローンを不安定化させるばかりか、そもそもモーメント入力を受け入れる実験プラットフォームは存在しません。
近年一般的なのは多項式軌道表現による全状態(位置, 速度, 加速度)の同時入力ですが、MPCやLQRなどの手法において多項式軌道表現は親和性が低いようにも感じます。
実機実験を行っているCBF及びMPCに関するドローンの理論研究はどのように制御入力を設計しているのでしょうか。

## 解決策

ドローンを対象としたCBF/MPCの実機実装に関する階層的アプローチについて、詳細な理論研究を行いました。サーベイ結果（Task 5）を踏まえ、理論研究で設計した制御入力（推力とモーメント）を実機に適用する際の変換方法や、実際の実験プラットフォームで利用可能な制御入力の種類と制約について整理しました。

### 主な成果

1. **ドローン制御の階層的アーキテクチャの整理**
   - 階層的制御の必要性
   - 典型的な階層構造
   - 階層間のインターフェース

2. **理論研究と実機実装のギャップの分析**
   - 理論研究における制御入力
   - 実機プラットフォームの制御インターフェース

3. **階層的CBF/MPC実装アプローチの提案**
   - 高レベル制御：CBF/MPC
   - 中間層：加速度から姿勢への変換
   - 低レベル制御：姿勢制御

4. **多項式軌道表現とMPC/CBFの統合方法の提案**
   - 多項式軌道表現の特徴
   - 多項式軌道とMPCの統合
   - 多項式軌道とCBFの統合
   - 実装例：最小スナップ軌道とCBF-MPC

5. **実機実装の実践的考慮事項の整理**
   - 計算効率とリアルタイム実装
   - センサノイズと状態推定
   - フェイルセーフと安全対策

### 階層的制御アーキテクチャ

ドローン制御の典型的な階層構造は以下の通りです：

1. **最高レベル（計画層）**: 経路計画、軌道生成
   - 入力: ミッション目標、環境地図
   - 出力: 時間パラメータ付き参照軌道（位置、速度、加速度など）
   - 周波数: 1-10Hz
   - アルゴリズム例: RRT*、A*、多項式軌道最適化

2. **高レベル（制御層）**: 位置・速度制御
   - 入力: 参照軌道、現在の状態推定
   - 出力: 目標姿勢（ロール、ピッチ、ヨー）と推力
   - 周波数: 50-100Hz
   - アルゴリズム例: MPC、CBF-QP、PID

3. **中間レベル（姿勢制御層）**: 姿勢制御
   - 入力: 目標姿勢と推力
   - 出力: 角速度指令と推力
   - 周波数: 200-400Hz
   - アルゴリズム例: 幾何学的制御、バックステッピング制御、PID

4. **低レベル（モーター制御層）**: モーター速度制御
   - 入力: 角速度指令と推力
   - 出力: モーターPWM信号
   - 周波数: 500-1000Hz
   - アルゴリズム例: PID、フィードフォワード制御

### 理論研究と実機実装のギャップ

理論研究では、ドローンのダイナミクスを以下のように定式化することが一般的です：

$$\dot{R} = R \omega^\wedge$$
$$\dot{p} = v$$
$$m \dot{v} = m g e_3 + R f e_3$$
$$J \dot{\omega} = J \omega \times \omega + \tau$$

ここで、制御入力は以下のベクトルとして定義されます：

$$u = [f, \tau_x, \tau_y, \tau_z]^T$$

この制御入力は、理論的には完全なシステム制御を可能にしますが、実機への直接適用には以下の課題があります：

1. **不安定性**: 推力とモーメントを直接入力すると、積分誤差や外乱に対して不安定になりやすい
2. **プラットフォーム非互換性**: 多くの実験プラットフォームは推力とモーメントを直接受け付けない
3. **モデル誤差**: 実機のダイナミクスは理想的なモデルと異なり、推力とモーメントの直接制御では誤差が蓄積する

実際のドローン実験プラットフォーム（PX4、ArduPilot等）は、以下のような制御インターフェースを提供しています：

1. **位置制御モード**: 目標位置、速度、加速度を入力
2. **姿勢制御モード**: 目標姿勢（ロール、ピッチ、ヨー）と推力を入力
3. **レート制御モード**: 目標角速度と推力を入力
4. **ダイレクトモーター制御モード**: 各モーターへのPWM値を入力

研究用途では、通常は姿勢制御モードまたはレート制御モードを使用することが多いです。

### 階層的CBF/MPC実装アプローチ

高レベル制御層では、CBFやMPCを用いて安全性と最適性を確保します。この層の入出力は以下の通りです：

**入力**:
- 参照軌道（位置、速度、加速度）
- 現在の状態推定（位置、速度、姿勢）
- 環境情報（障害物位置など）

**出力**:
- 目標加速度ベクトル $a_{des} \in \mathbb{R}^3$
- 目標ヨー角 $\psi_{des}$

中間層では、目標加速度ベクトル $a_{des}$ から目標姿勢（ロール $\phi_{des}$、ピッチ $\theta_{des}$、ヨー $\psi_{des}$）と正規化推力 $T_{des}$ への変換を行います：

1. 目標推力ベクトルの計算：
   $$\vec{T}_{des} = m(a_{des} - \vec{g})$$

2. 推力の大きさの計算：
   $$T_{des} = \|\vec{T}_{des}\|$$

3. 目標姿勢の計算：
   - 目標$z$軸方向（推力方向）：$\vec{z}_{B,des} = \frac{\vec{T}_{des}}{\|\vec{T}_{des}\|}$
   - 目標$x$軸方向（前方方向）：
     $$\vec{x}_{C,des} = [\cos\psi_{des}, \sin\psi_{des}, 0]^T$$
     $$\vec{y}_{B,des} = \frac{\vec{z}_{B,des} \times \vec{x}_{C,des}}{\|\vec{z}_{B,des} \times \vec{x}_{C,des}\|}$$
     $$\vec{x}_{B,des} = \vec{y}_{B,des} \times \vec{z}_{B,des}$$
   
   - 目標回転行列：$R_{des} = [\vec{x}_{B,des}, \vec{y}_{B,des}, \vec{z}_{B,des}]$
   
   - オイラー角への変換：
     $$\phi_{des} = \text{atan2}(R_{des,32}, R_{des,33})$$
     $$\theta_{des} = \text{asin}(-R_{des,31})$$
     $$\psi_{des} = \text{atan2}(R_{des,21}, R_{des,11})$$

4. 正規化推力の計算：
   $$T_{norm} = \frac{T_{des}}{T_{max}}$$

低レベル制御層では、目標姿勢と推力を実現するための姿勢制御を行います。この層は通常、ドローンのフライトコントローラ（PX4、ArduPilotなど）に実装されています。

### 多項式軌道表現とMPC/CBFの統合

多項式軌道表現とMPC/CBFを統合する方法には、以下のアプローチがあります：

1. **参照軌道としての利用**:
   - 多項式軌道を生成し、それをMPCの参照軌道として使用
   - MPCは参照軌道からの偏差を最小化するように制御入力を計算

2. **MPC内での多項式パラメータ最適化**:
   - MPCの決定変数として多項式係数を直接最適化
   - 制約条件として多項式の連続性や境界条件を課す

3. **モデル予測輪郭制御（MPCC）**:
   - 空間的な参照曲線（多項式スプライン等）を定義
   - 時間パラメータをMPCの決定変数として最適化
   - 曲線に沿った進行と偏差の両方を考慮した目的関数を設計

多項式軌道とCBFを統合する方法には、以下のアプローチがあります：

1. **CBF安全フィルタの適用**:
   - 多項式軌道を生成
   - CBF-QPを用いて軌道を安全に修正
   - 修正された軌道を追従

2. **CBF制約付き軌道最適化**:
   - 軌道最適化問題にCBF制約を追加
   - 最適化問題を解いて安全な多項式軌道を生成

3. **オンライン軌道再計画**:
   - CBF違反が検出された場合に軌道を再計画
   - 新しい安全な多項式軌道を生成

### 実機実装の実践的考慮事項

実機実装では、計算効率とリアルタイム性が重要です。以下の手法を用いて、計算効率を向上させることができます：

1. **Explicit MPC**:
   - オフラインで最適解を計算し、テーブル化
   - オンラインでは単純なテーブル参照のみ
   - 計算コストを大幅に削減可能

2. **線形化と簡略化**:
   - 非線形ダイナミクスを線形化
   - 高次の項を無視して簡略化
   - 計算コストを削減しつつ、十分な精度を維持

3. **並列計算**:
   - GPUやマルチコアCPUを活用
   - 独立した計算を並列化
   - 計算時間を短縮

4. **早期終了条件**:
   - 最適化アルゴリズムの反復回数に上限を設定
   - 収束条件を緩和
   - 厳密な最適解ではなく、実用的な近似解を採用

実機実装では、センサノイズと状態推定の不確かさが問題となります。以下の手法を用いて、これらの問題に対処できます：

1. **ロバスト制御**:
   - ノイズや不確かさを明示的にモデル化
   - 最悪ケースでも安全性を保証するロバストCBF
   - 不確かさを考慮したロバストMPC

2. **状態推定の改善**:
   - 拡張カルマンフィルタ（EKF）や粒子フィルタを用いた状態推定
   - センサフュージョン（IMU、カメラ、GPS等）
   - 外乱オブザーバを用いた外乱推定

3. **適応制御**:
   - システムパラメータをオンラインで推定
   - 推定されたパラメータに基づいて制御則を適応的に調整
   - モデル誤差の影響を低減

実機実験では、安全性が最も重要です。以下の安全対策を実装することをお勧めします：

1. **バックアップ制御器**:
   - 高度な制御器（MPC、CBF等）が失敗した場合のバックアップとしてシンプルなPID制御器を用意
   - 制御器の切り替え条件を明確に定義

2. **仮想安全壁**:
   - 実験領域の境界にCBFによる仮想安全壁を設定
   - 境界を超えようとすると自動的に阻止

3. **緊急停止機能**:
   - リモコンの緊急停止ボタン
   - 異常検出時の自動緊急着陸
   - 通信途絶時の自動帰還

4. **段階的テスト**:
   - シミュレーションでの十分な検証
   - 拘束条件下での初期テスト
   - 制限された空間での飛行テスト
   - 徐々に複雑な環境でのテスト

## 成果物

詳細な理論研究の結果は、以下のドキュメントにまとめました：

- `doc/theory/drone_implementation_hierarchy.md`: ドローンを対象としたCBF/MPCの実機実装に関する階層的アプローチについての詳細な理論研究

このドキュメントでは、ドローン制御の階層的アーキテクチャ、理論研究と実機実装のギャップ、階層的CBF/MPC実装アプローチ、多項式軌道表現とMPC/CBFの統合、実機実装の実践的考慮事項について、包括的に説明しています。

## 今後の展望

1. **シミュレーション検証**
   - 階層的CBF/MPC実装アプローチのシミュレーション実装
   - 多項式軌道表現とMPC/CBFの統合のシミュレーション検証
   - パラメータ感度分析

2. **実機実装**
   - PX4またはArduPilotを用いた実機実装
   - 階層的制御アーキテクチャの実装
   - 実機実験による検証

3. **理論的拡張**
   - 適応型階層的制御
   - 学習ベースの階層的制御
   - 分散型階層的制御

ドローンを対象としたCBF/MPCの実機実装に関する階層的アプローチの研究により、理論研究で設計した制御入力（推力とモーメント）を実機に適用する際の変換方法や、実際の実験プラットフォームで利用可能な制御入力の種類と制約について理解が深まりました。これにより、理論研究の成果を実機実験に効果的に適用し、安全かつ高性能なドローン制御システムを実現することが可能になります。
